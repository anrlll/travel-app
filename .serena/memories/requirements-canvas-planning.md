# TravelApp 要件定義 - キャンバスベース旅行プラン作成画面

**ステータス**: ✅ 確定
**優先度**: 最高（コア機能）
**最終更新**: 2025-10-13

---

## 概要

Miro風の無限キャンバス上でアクティビティカードを自由に配置・接続し、複数のプラン案を同時に検討できる革新的な旅行プラン作成画面。

---

## 主要機能

### 1. 無限キャンバス
- ✅ 上下左右に制限なく拡張可能
- ✅ ズーム機能（25%〜400%）
- ✅ パン操作（スペースキー + ドラッグ）
- ✅ グリッド表示（10px間隔）
- ✅ ミニマップ（オプション）

### 2. アクティビティカード
- **詳細情報表示**: タイトル、場所、時間、料金、参加メンバー、メモ
- **カードサイズ**: 幅280px、高さ可変（180px〜400px）
- **作成方法**:
  1. 新規作成（キャンバス上でクリック）
  2. 行きたい場所から作成（登録場所を選択）
  3. カードのコピー（Ctrl + C/V）
- **編集**: ダブルクリックで詳細編集ダイアログ
- **ドラッグ&ドロップ**: 自由に移動可能

### 3. ノード接続システム
- **接続方法**: カードAからカードBへ矢印でドラッグ
- **矢印の方向**: アクティビティの順序を表す（A → B → C）
- **色分け**: プラン案ごとに色を割り当て
  - プラン案A: 🔵 ブルー
  - プラン案B: 🟢 グリーン
  - プラン案C: 🟣 パープル
- **移動情報**: 接続線上に移動時間・費用を表示

### 4. プラン案の自動生成
- **自動検出**: 接続されたカードグループを自動的にプラン案として認識
- **命名**: プラン案A、B、C...（手動変更可能）
- **手動編集**: プラン案パネルでグループ化を修正可能
- **複数カード使用**: 同じカードを複数プラン案で使い回す場合はコピー必須

### 5. 日程割り当て機能
- **タイミング**: プラン案作成後、日程を割り当て
- **日程設定UI**: プラン案詳細パネルで日付ピッカーを使用
- **ドラッグ&ドロップ**: アクティビティを別の日へ移動可能
- **自動提案**: 均等に日程を分配（オプション）

### 6. プラン案比較機能
- **横並び比較**: 複数プラン案を並べて表示
- **比較項目**:
  - 日数、予算、訪問地数、参加メンバー数
  - 移動距離、移動時間
  - 食事回数、宿泊数
- **切り替え表示**: タブ、スライドショー、重ね合わせ

### 7. 正式プラン選択と下書き管理
- **正式プラン選択**: 1つのプラン案を正式プランとして確定
- **下書き保存**: 選択されなかったプラン案は下書きとして保存
- **下書きアクセス**: いつでも閲覧・編集・削除可能
- **正式プランへ昇格**: 下書きを正式プランに変更可能
- **保存上限**: 最大10個の下書き

### 8. メンバー管理
- **設定タイミング**: キャンバス作成開始時
- **いつでも変更可能**: メンバー追加・削除はいつでも可能
- **アクティビティごとの設定**: カード編集時に参加メンバーを選択

### 9. 予算管理
- **自動計算**: プラン案ごとの総予算を自動算出
- **リアルタイム更新**: カードの料金変更時に即座に反映
- **予算オーバー警告**: 設定した上限を超えた場合は警告表示

---

## データベース設計

### 新規テーブル

#### canvas_activity_cards（キャンバス上のアクティビティカード）
- id, trip_plan_id, position_x, position_y
- title, activity_type, saved_place_id, custom_location
- start_time, end_time, cost, budget_category, memo, participants
- is_collapsed, is_completed

#### card_connections（カード間の接続）
- id, trip_plan_id, from_card_id, to_card_id
- transport_type, duration_minutes, distance_km, cost, route_data
- proposal_id（どのプラン案に属するか）

#### trip_plan_proposals（旅行プラン案）
- id, trip_plan_id, name, color, is_official
- start_date, end_date
- total_budget, activity_count, total_distance_km（自動計算）

#### proposal_activities（プラン案のアクティビティ割り当て）
- id, proposal_id, card_id
- day_number, order_in_day（日程割り当て）

---

## フロントエンド実装

### 推奨技術スタック
**React Flow**（推奨）
- ✅ ノード・エッジ管理が容易
- ✅ ズーム・パン機能標準搭載
- ✅ TypeScript完全対応
- ✅ カスタマイズ性が高い

### 主要コンポーネント
- `PlanningCanvas`: メインキャンバス画面
- `ActivityCard`: アクティビティカード
- `ConnectionEdge`: 接続線
- `ProposalPanel`: プラン案管理パネル
- `PlanComparisonView`: プラン案比較表示

### 状態管理（Zustand）
- キャンバス状態（ズーム、位置、選択）
- アクティビティカード一覧
- 接続線一覧
- プラン案一覧
- 各種アクション（追加、更新、削除、移動、コピー等）

---

## ユーザーフロー

```
1. 旅行プラン作成開始
   ↓
2. メンバー設定
   ↓
3. キャンバスにアクティビティカード配置
   - 行きたい場所から追加
   - 新規作成
   - 自由に配置してアイデアを練る
   ↓
4. カードを接続してルートを作成
   - 複数のルート案を同時に作成
   - プラン案A、B、Cが自動生成される
   ↓
5. プラン案ごとに日程割り当て
   ↓
6. プラン案を比較
   - 予算、日数、訪問地数等
   ↓
7. 正式プランを1つ選択
   - 他は下書きとして保存
   ↓
8. 正式プランが旅行プラン検索に表示される
```

---

## パフォーマンス最適化

- **仮想化**: 表示領域外のカードは非描画
- **メモ化**: React.memoでカードコンポーネントをメモ化
- **デバウンス**: カード移動時は0.5秒後にDB保存
- **楽観的更新**: UI即座に更新、バックグラウンドでDB保存

---

## アクセシビリティ

- キーボード操作対応（Tab、矢印キー、ショートカット等）
- スクリーンリーダー対応（ARIAラベル）
- WCAG 2.1 Level AA準拠

---

## 関連ドキュメント

詳細は docs/requirements/02-1-canvas-planning.md を参照