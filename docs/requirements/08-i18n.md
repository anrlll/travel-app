# 多言語対応（Internationalization） - 要件定義

**ステータス**: ✅ 確定
**優先度**: 高（Phase 1実装範囲）
**最終更新日**: 2025-10-13

---

## 1. 概要

TravelAppの多言語対応（i18n）の要件を定義します。Phase 1では日本語と英語に対応し、将来的に他言語への拡張が容易な設計とします。

---

## 2. 対応言語

### 2.1 Phase 1対応言語

| 言語 | ロケールコード | 説明 |
|------|--------------|------|
| 日本語 | `ja` | デフォルト言語 |
| 英語 | `en` | 第二言語 |

### 2.2 Phase 2以降検討言語

- 中国語（簡体字）: `zh-CN`
- 韓国語: `ko`
- 英語（米国）: `en-US`
- 英語（英国）: `en-GB`

---

## 3. 実装方針

### 3.1 使用ライブラリ

#### フロントエンド
- **react-i18next**: React用の国際化ライブラリ
- **i18next**: コアライブラリ
- **i18next-browser-languagedetector**: ブラウザ言語自動検出

#### バックエンド
- **i18next**: Node.js用
- **i18next-fs-backend**: ファイルシステムから翻訳ファイル読み込み

---

### 3.2 翻訳ファイル構造

```
public/
└── locales/
    ├── ja/
    │   ├── common.json          # 共通（ボタン、ラベル等）
    │   ├── auth.json            # 認証関連
    │   ├── tripPlan.json        # 旅行プラン関連
    │   ├── budget.json          # 予算管理関連
    │   ├── memory.json          # 思い出関連
    │   ├── search.json          # 検索関連
    │   ├── errors.json          # エラーメッセージ
    │   └── validation.json      # バリデーションメッセージ
    └── en/
        ├── common.json
        ├── auth.json
        ├── tripPlan.json
        ├── budget.json
        ├── memory.json
        ├── search.json
        ├── errors.json
        └── validation.json
```

---

### 3.3 翻訳キーの命名規則

#### 命名パターン
```
{カテゴリ}.{機能}.{要素}
```

#### 例
```json
{
  "auth.login.title": "ログイン",
  "auth.login.email": "メールアドレス",
  "auth.login.password": "パスワード",
  "auth.login.submit": "ログイン",
  "auth.login.forgotPassword": "パスワードをお忘れですか？",

  "tripPlan.create.title": "旅行プランを作成",
  "tripPlan.create.name": "プラン名",
  "tripPlan.create.startDate": "開始日",
  "tripPlan.create.endDate": "終了日",

  "common.button.save": "保存",
  "common.button.cancel": "キャンセル",
  "common.button.delete": "削除",
  "common.button.edit": "編集"
}
```

---

### 3.4 翻訳ファイル例

#### `public/locales/ja/common.json`
```json
{
  "appName": "TravelApp",
  "button": {
    "save": "保存",
    "cancel": "キャンセル",
    "delete": "削除",
    "edit": "編集",
    "create": "作成",
    "search": "検索",
    "filter": "フィルター",
    "sort": "並び替え",
    "back": "戻る",
    "next": "次へ",
    "previous": "前へ",
    "close": "閉じる",
    "confirm": "確認",
    "submit": "送信"
  },
  "nav": {
    "home": "ホーム",
    "tripPlans": "旅行プラン",
    "savedPlaces": "行きたい場所",
    "memories": "思い出",
    "profile": "プロフィール",
    "settings": "設定",
    "logout": "ログアウト"
  },
  "label": {
    "language": "言語",
    "theme": "テーマ"
  },
  "message": {
    "loading": "読み込み中...",
    "noData": "データがありません",
    "success": "成功しました",
    "error": "エラーが発生しました"
  }
}
```

#### `public/locales/en/common.json`
```json
{
  "appName": "TravelApp",
  "button": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "create": "Create",
    "search": "Search",
    "filter": "Filter",
    "sort": "Sort",
    "back": "Back",
    "next": "Next",
    "previous": "Previous",
    "close": "Close",
    "confirm": "Confirm",
    "submit": "Submit"
  },
  "nav": {
    "home": "Home",
    "tripPlans": "Trip Plans",
    "savedPlaces": "Saved Places",
    "memories": "Memories",
    "profile": "Profile",
    "settings": "Settings",
    "logout": "Logout"
  },
  "label": {
    "language": "Language",
    "theme": "Theme"
  },
  "message": {
    "loading": "Loading...",
    "noData": "No data available",
    "success": "Success",
    "error": "An error occurred"
  }
}
```

---

## 4. フロントエンド実装

### 4.1 初期設定

```typescript
// src/i18n.ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';
import Backend from 'i18next-http-backend';

i18n
  .use(Backend)
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    fallbackLng: 'ja', // デフォルト言語
    supportedLngs: ['ja', 'en'],

    // 名前空間（翻訳ファイル分割）
    ns: ['common', 'auth', 'tripPlan', 'budget', 'memory', 'search', 'errors', 'validation'],
    defaultNS: 'common',

    // バックエンド設定（翻訳ファイルのロード）
    backend: {
      loadPath: '/locales/{{lng}}/{{ns}}.json',
    },

    // 言語検出設定
    detection: {
      order: ['localStorage', 'navigator'],
      caches: ['localStorage'],
    },

    interpolation: {
      escapeValue: false, // React はデフォルトで XSS 対策済み
    },

    react: {
      useSuspense: true, // Suspense コンポーネントを使用
    },
  });

export default i18n;
```

---

### 4.2 コンポーネントでの使用

#### 基本的な使用方法
```typescript
import { useTranslation } from 'react-i18next';

const LoginPage = () => {
  const { t } = useTranslation('auth');

  return (
    <div>
      <h1>{t('login.title')}</h1>
      <form>
        <label>{t('login.email')}</label>
        <input type="email" />

        <label>{t('login.password')}</label>
        <input type="password" />

        <button type="submit">{t('login.submit')}</button>
      </form>
    </div>
  );
};
```

#### 変数の埋め込み
```typescript
// 翻訳ファイル
{
  "tripPlan.detail.duration": "{{days}}日間の旅行"
}

// コンポーネント
const { t } = useTranslation('tripPlan');
<p>{t('detail.duration', { days: 3 })}</p>
// 出力: "3日間の旅行"
```

#### 複数形対応
```typescript
// 翻訳ファイル
{
  "tripPlan.list.count_one": "{{count}}件の旅行プラン",
  "tripPlan.list.count_other": "{{count}}件の旅行プラン"
}

// コンポーネント
<p>{t('list.count', { count: tripPlans.length })}</p>
```

---

### 4.3 言語切り替え機能

```typescript
import { useTranslation } from 'react-i18next';

const LanguageSwitcher = () => {
  const { i18n } = useTranslation();

  const changeLanguage = (lng: string) => {
    i18n.changeLanguage(lng);
  };

  return (
    <div>
      <button
        onClick={() => changeLanguage('ja')}
        className={i18n.language === 'ja' ? 'active' : ''}
      >
        日本語
      </button>
      <button
        onClick={() => changeLanguage('en')}
        className={i18n.language === 'en' ? 'active' : ''}
      >
        English
      </button>
    </div>
  );
};
```

---

### 4.4 Suspenseコンポーネント

```typescript
import { Suspense } from 'react';
import { useTranslation } from 'react-i18next';

const App = () => {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <MainApp />
    </Suspense>
  );
};

const MainApp = () => {
  const { t } = useTranslation();
  return <div>{t('common.appName')}</div>;
};
```

---

## 5. 日付・時刻のフォーマット

### 5.1 date-fns使用

```typescript
import { format } from 'date-fns';
import { ja, enUS } from 'date-fns/locale';
import { useTranslation } from 'react-i18next';

const DateDisplay = ({ date }: { date: Date }) => {
  const { i18n } = useTranslation();

  const locale = i18n.language === 'ja' ? ja : enUS;

  return (
    <span>
      {format(date, 'PPP', { locale })}
      {/* 日本語: 2025年10月13日 */}
      {/* 英語: October 13th, 2025 */}
    </span>
  );
};
```

---

### 5.2 相対時間表示

```typescript
import { formatDistanceToNow } from 'date-fns';
import { ja, enUS } from 'date-fns/locale';

const RelativeTime = ({ date }: { date: Date }) => {
  const { i18n } = useTranslation();
  const locale = i18n.language === 'ja' ? ja : enUS;

  return (
    <span>
      {formatDistanceToNow(date, { addSuffix: true, locale })}
      {/* 日本語: 3日前 */}
      {/* 英語: 3 days ago */}
    </span>
  );
};
```

---

## 6. 通貨のフォーマット

### 6.1 Phase 1: 日本円固定

```typescript
const formatCurrency = (amount: number): string => {
  return `¥${amount.toLocaleString('ja-JP')}`;
};

// 使用例
<span>{formatCurrency(10000)}</span>
// 出力: ¥10,000
```

---

### 6.2 Phase 2: 複数通貨対応（将来実装）

```typescript
const formatCurrency = (amount: number, currency: string, locale: string): string => {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: currency,
  }).format(amount);
};

// 使用例
formatCurrency(10000, 'JPY', 'ja-JP'); // ¥10,000
formatCurrency(100, 'USD', 'en-US');   // $100.00
```

---

## 7. エラーメッセージの国際化

### 7.1 翻訳ファイル

#### `public/locales/ja/errors.json`
```json
{
  "AUTH_INVALID_CREDENTIALS": "メールアドレスまたはパスワードが正しくありません",
  "AUTH_TOKEN_EXPIRED": "セッションの有効期限が切れました。再度ログインしてください",
  "VALIDATION_ERROR": "入力内容に誤りがあります",
  "NETWORK_ERROR": "ネットワークエラーが発生しました。再度お試しください",
  "NOT_FOUND": "お探しのページが見つかりませんでした",
  "INTERNAL_ERROR": "サーバーエラーが発生しました。しばらくしてから再度お試しください"
}
```

#### `public/locales/en/errors.json`
```json
{
  "AUTH_INVALID_CREDENTIALS": "Invalid email or password",
  "AUTH_TOKEN_EXPIRED": "Your session has expired. Please log in again",
  "VALIDATION_ERROR": "Invalid input data",
  "NETWORK_ERROR": "A network error occurred. Please try again",
  "NOT_FOUND": "The page you are looking for was not found",
  "INTERNAL_ERROR": "A server error occurred. Please try again later"
}
```

---

### 7.2 エラーハンドリング

```typescript
import { useTranslation } from 'react-i18next';

const ErrorMessage = ({ errorCode }: { errorCode: string }) => {
  const { t } = useTranslation('errors');

  return (
    <div className="error">
      {t(errorCode)}
    </div>
  );
};

// 使用例
try {
  await loginUser(email, password);
} catch (error) {
  setError(error.code); // 例: 'AUTH_INVALID_CREDENTIALS'
}
```

---

## 8. バリデーションメッセージの国際化

### 8.1 Zodスキーマとi18nの統合

```typescript
import { z } from 'zod';
import { useTranslation } from 'react-i18next';

const useLoginSchema = () => {
  const { t } = useTranslation('validation');

  return z.object({
    email: z
      .string()
      .min(1, { message: t('email.required') })
      .email({ message: t('email.invalid') }),
    password: z
      .string()
      .min(8, { message: t('password.minLength', { min: 8 }) }),
  });
};
```

---

### 8.2 翻訳ファイル

#### `public/locales/ja/validation.json`
```json
{
  "email": {
    "required": "メールアドレスを入力してください",
    "invalid": "有効なメールアドレスを入力してください"
  },
  "password": {
    "required": "パスワードを入力してください",
    "minLength": "パスワードは{{min}}文字以上である必要があります"
  },
  "tripPlan": {
    "name": {
      "required": "旅行プラン名を入力してください",
      "maxLength": "旅行プラン名は{{max}}文字以内で入力してください"
    },
    "startDate": {
      "required": "開始日を選択してください"
    },
    "endDate": {
      "required": "終了日を選択してください",
      "afterStartDate": "終了日は開始日より後である必要があります"
    }
  }
}
```

---

## 9. SEO・メタデータの国際化

### 9.1 React Helmet使用

```typescript
import { Helmet } from 'react-helmet-async';
import { useTranslation } from 'react-i18next';

const TripPlanPage = () => {
  const { t, i18n } = useTranslation('tripPlan');

  return (
    <>
      <Helmet>
        <html lang={i18n.language} />
        <title>{t('meta.title')} | TravelApp</title>
        <meta name="description" content={t('meta.description')} />
      </Helmet>
      {/* ページコンテンツ */}
    </>
  );
};
```

---

## 10. バックエンドAPIレスポンスの国際化

### 10.1 Accept-Languageヘッダー

```typescript
// フロントエンド: Axios設定
axios.defaults.headers.common['Accept-Language'] = i18n.language;

// バックエンド: Fastify
app.decorateRequest('locale', null);

app.addHook('onRequest', async (request, reply) => {
  const locale = request.headers['accept-language']?.split(',')[0] || 'ja';
  request.locale = locale;
});
```

---

### 10.2 エラーメッセージの国際化

```typescript
// バックエンド: i18next設定
import i18next from 'i18next';
import Backend from 'i18next-fs-backend';

i18next
  .use(Backend)
  .init({
    fallbackLng: 'ja',
    supportedLngs: ['ja', 'en'],
    backend: {
      loadPath: './locales/{{lng}}/{{ns}}.json',
    },
  });

// エラーレスポンス
reply.status(400).send({
  error: {
    code: 'VALIDATION_ERROR',
    message: i18next.t('errors:VALIDATION_ERROR', { lng: request.locale }),
  },
});
```

---

## 11. CLAUDE.md準拠の開発ルール

### 11.1 コード内コメント

**ルール**: すべてのコメントは日本語で記述

```typescript
// ✅ 正しい例
// ユーザーをログインさせる関数
const loginUser = async (email: string, password: string) => {
  // パスワードを検証
  const isValid = await verifyPassword(email, password);
  // ...
};

// ❌ 誤った例
// Login user function
const loginUser = async (email: string, password: string) => {
  // Verify password
  // ...
};
```

---

### 11.2 変数名・関数名

**ルール**: 英語を使用（国際標準に準拠）

```typescript
// ✅ 正しい例
const tripPlanName = "新潟旅行";
const createTripPlan = () => { /* ... */ };

// ❌ 誤った例
const 旅行プラン名 = "新潟旅行";
const 旅行プラン作成 = () => { /* ... */ };
```

---

### 11.3 UI表示文字列

**ルール**: ハードコードせず、必ずi18nキーを使用

```typescript
// ✅ 正しい例
<button>{t('common.button.save')}</button>

// ❌ 誤った例
<button>保存</button>
```

---

## 12. テスト要件

### 12.1 ユニットテスト

- 翻訳キーの存在確認
- 言語切り替え機能のテスト
- 日付・通貨フォーマット関数のテスト

---

### 12.2 統合テスト

- ページ全体の翻訳が正しく適用されるか
- 言語切り替え時の再レンダリング確認
- エラーメッセージの国際化確認

---

### 12.3 翻訳ファイルのバリデーション

```typescript
// tests/i18n/validate-translations.test.ts
import jaCommon from '../../public/locales/ja/common.json';
import enCommon from '../../public/locales/en/common.json';

describe('Translation files validation', () => {
  it('should have same keys in ja and en', () => {
    const jaKeys = Object.keys(jaCommon);
    const enKeys = Object.keys(enCommon);

    expect(jaKeys).toEqual(enKeys);
  });
});
```

---

## 13. 翻訳ワークフロー

### 13.1 翻訳追加プロセス

1. **開発者**: 日本語翻訳ファイルに新しいキーを追加
2. **開発者**: コンポーネントで `t('newKey')` を使用
3. **翻訳者**: 英語翻訳ファイルに対応するキーと翻訳を追加
4. **レビュー**: プルリクエストで翻訳内容をレビュー

---

### 13.2 翻訳管理ツール（Phase 2検討）

- **Lokalise**: 翻訳管理プラットフォーム
- **Crowdin**: コラボレーション翻訳プラットフォーム

---

## 14. 受け入れ基準

### 14.1 機能要件

- ✅ 日本語・英語の言語切り替えが動作する
- ✅ ブラウザ言語が自動検出される
- ✅ 言語設定がlocalStorageに保存される
- ✅ すべてのUI文字列が翻訳ファイルから読み込まれる
- ✅ 日付・時刻が適切にフォーマットされる
- ✅ エラーメッセージが国際化されている

### 14.2 品質要件

- ✅ 翻訳ファイルのキーが日本語・英語で一致している
- ✅ ハードコードされた文字列が存在しない
- ✅ CLAUDE.md準拠（コメント日本語、変数名英語）

### 14.3 パフォーマンス要件

- ✅ 言語切り替えが1秒以内に完了する
- ✅ 翻訳ファイルが遅延ロードされる（Suspense使用）

---

## 15. 関連ドキュメント

- [要件概要](./00-overview.md)
- [ユーザー管理と認証](./05-authentication.md) - ユーザーのlocale設定
- [非機能要件](./06-non-functional.md)
- [CLAUDE.md](../../CLAUDE.md) - 実装ルール（日本語コメント、英語変数名）
